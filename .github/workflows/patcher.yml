name: Framework Patcher

on:
  workflow_dispatch:
    inputs:
      api_level:
        description: 'Android API level'
        required: true
        default: '35'
        type: string
      device_name:
        description: 'Device codename (e.g. rothko)'
        required: true
        type: string
      version_name:
        description: 'MIUI/ROM version (e.g. OS2.0.200.33)'
        required: true
        type: string
      framework_url:
        description: 'URL to framework.jar'
        required: true
        type: string
      services_url:
        description: 'URL to services.jar'
        required: true
        type: string
      miui_services_url:
        description: 'URL to miui-services.jar'
        required: true
        type: string
      user_id:
        description: 'Telegram User ID to notify'
        required: true
        type: string

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup environment
        run: |
          mkdir -p {framework,services,miui_services,tools}_decompile

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full android-sdk-build-tools zipalign
          # Fallback if package not found
          if ! command -v zipalign &> /dev/null; then
            sudo apt-get install -y android-tools-zipalign
          fi

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download tools
        run: |
          mkdir -p tools
          wget -O tools/baksmali.jar https://github.com/baksmali/smali/releases/download/3.0.9/baksmali-3.0.9-fat.jar
          wget -O tools/smali.jar https://github.com/baksmali/smali/releases/download/3.0.9/smali-3.0.9-fat.jar
          chmod +x tools/*.jar

      - name: Download framework JARs
        run: |
          wget -O framework.jar "${{ github.event.inputs.framework_url }}"
          wget -O services.jar "${{ github.event.inputs.services_url }}"
          wget -O miui-services.jar "${{ github.event.inputs.miui_services_url }}"

      - name: Patch JARs and Create Module
        run: |
          chmod +x scripts/github_patcher.sh
          ./scripts/github_patcher.sh \
            ${{ github.event.inputs.api_level }} \
            "${{ github.event.inputs.device_name }}" \
            "${{ github.event.inputs.version_name }}" \
            --framework --services --miui-services

      - name: Set Release Info
        id: release_info
        run: |
          # Format version name to be git tag friendly (replace spaces and dots with hyphens)
          SAFE_VERSION=$(echo "${{ github.event.inputs.version_name }}" | sed 's/[. ]/-/g')
          RELEASE_TAG="${{ github.event.inputs.device_name }}_${SAFE_VERSION}"
          echo "tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "name=Framework Patch for ${{ github.event.inputs.device_name }} (${{ github.event.inputs.version_name }})" >> $GITHUB_OUTPUT

      - name: Find Module ZIP
        id: find_zip
        run: |
          ZIP_FILE=$(ls Framework-Patcher-${{ github.event.inputs.device_name }}*.zip)
          echo "file_path=${ZIP_FILE}" >> $GITHUB_OUTPUT

      - name: Delete Existing Release
        uses: actions/github-script@v6
        continue-on-error: true
        with:
          script: |
            try {
              const releases = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo
              });

              const existingRelease = releases.data.find(r => r.tag_name === '${{ steps.release_info.outputs.tag }}');

              if (existingRelease) {
                console.log('Found existing release, deleting...');
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: existingRelease.id
                });

                // Delete the tag
                try {
                  await github.rest.git.deleteRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: 'tags/${{ steps.release_info.outputs.tag }}'
                  });
                } catch (e) {
                  console.log('Tag might not exist, continuing...');
                }
              }
            } catch (e) {
              console.log('No existing release found or error occurred:', e.message);
            }

      - name: Generate Release Body
        id: generate_release_body
        run: |
          BODY="Framework Patcher for ${{ github.event.inputs.device_name }}
          Version: ${{ github.event.inputs.version_name }}
          Android API: ${{ github.event.inputs.api_level }}

          Sources:
          - Framework: ${{ github.event.inputs.framework_url }}
          - Services: ${{ github.event.inputs.services_url }}
          - MIUI Services: ${{ github.event.inputs.miui_services_url }}

          Build date: $(date +'%Y-%m-%d')
          Build time: $(date +'%H:%M:%S UTC')"
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: ${{ steps.release_info.outputs.name }}
          files: ${{ steps.find_zip.outputs.file_path }}
          body: ${{ steps.generate_release_body.outputs.release_body }}

      - name: Send Telegram Notification (Success)
        if: success()
        run: |
          escape_md() {
            echo "$1" | sed -e 's/\\/\\\\/g' \
                            -e 's/\./\\./g' \
                            -e 's/\-/\\-/g' \
                            -e 's/(/\\(/g' \
                            -e 's/)/\\)/g' \
                            -e 's/\[/\\[/g' \
                            -e 's/\]/\\]/g' \
                            -e 's/{/\\{/g' \
                            -e 's/}/\\}/g' \
                            -e 's/</\\</g' \
                            -e 's/>/\\>/g' \
                            -e 's/#/\\#/g' \
                            -e 's/\+/\\+/g' \
                            -e 's/=/\\=/g' \
                            -e 's/|/\\|/g' \
                            -e 's/~/\\~/g' \
                            -e 's/`/\\`/g' \
                            -e 's/_/\\_/g' \
                            -e 's/\*/\\*/g' \
                            -e 's/!/\\!/g'
          }

          DEVICE_NAME_ESCAPED=$(escape_md "${{ github.event.inputs.device_name }}")
          VERSION_NAME_ESCAPED=$(escape_md "${{ github.event.inputs.version_name }}")
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_info.outputs.tag }}"
          RELEASE_URL_ESCAPED=$(escape_md "$RELEASE_URL")

          MESSAGE="Your framework patch for ${DEVICE_NAME_ESCAPED} \\(${VERSION_NAME_ESCAPED}\\) is ready\\! Download it here: ${RELEASE_URL_ESCAPED}"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ github.event.inputs.user_id }} \
            -d text="$MESSAGE" \
            -d parse_mode="MarkdownV2" \
            -d disable_web_page_preview=true

      - name: Send Telegram Notification (Failure)
        if: failure()
        run: |
          escape_md() {
            echo "$1" | sed -e 's/\\/\\\\/g' \
                            -e 's/\./\\./g' \
                            -e 's/\-/\\-/g' \
                            -e 's/(/\\(/g' \
                            -e 's/)/\\)/g' \
                            -e 's/\[/\\[/g' \
                            -e 's/\]/\\]/g' \
                            -e 's/{/\\{/g' \
                            -e 's/}/\\}/g' \
                            -e 's/</\\</g' \
                            -e 's/>/\\>/g' \
                            -e 's/#/\\#/g' \
                            -e 's/\+/\\+/g' \
                            -e 's/=/\\=/g' \
                            -e 's/|/\\|/g' \
                            -e 's/~/\\~/g' \
                            -e 's/`/\\`/g' \
                            -e 's/_/\\_/g' \
                            -e 's/\*/\\*/g' \
                            -e 's/!/\\!/g'
          }

          DEVICE_NAME_ESCAPED=$(escape_md "${{ github.event.inputs.device_name }}")
          VERSION_NAME_ESCAPED=$(escape_md "${{ github.event.inputs.version_name }}")
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          WORKFLOW_URL_ESCAPED=$(escape_md "$WORKFLOW_URL")

          MESSAGE="Your framework patch for ${DEVICE_NAME_ESCAPED} \\(${VERSION_NAME_ESCAPED}\\) failed\\! Check logs here: ${WORKFLOW_URL_ESCAPED}"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ github.event.inputs.user_id }} \
            -d text="$MESSAGE" \
            -d parse_mode="MarkdownV2" \
            -d disable_web_page_preview=true
