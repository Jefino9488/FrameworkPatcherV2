name: Framework Patcher

on:
  workflow_dispatch:
    inputs:
      framework_url:
        description: 'URL to framework.jar'
        required: true
      services_url:
        description: 'URL to services.jar'
        required: true
      miui_services_url:
        description: 'URL to miui-services.jar'
        required: true
      api_level:
        description: 'Android API level'
        required: true
        default: '34'

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Create directories
        run: |
          mkdir -p framework tools

      - name: Download tools
        run: |
          wget -O tools/baksmali.jar https://github.com/baksmali/smali/releases/download/3.0.9/baksmali-3.0.9-fat.jar
          wget -O tools/smali.jar https://github.com/baksmali/smali/releases/download/3.0.9/smali-3.0.9-fat.jar
          chmod +x tools/*.jar

      - name: Download JARs
        run: |
          if [ -n "${{ github.event.inputs.framework_url }}" ]; then
            wget -O framework.jar ${{ github.event.inputs.framework_url }}
          fi
          if [ -n "${{ github.event.inputs.services_url }}" ]; then
            wget -O services.jar ${{ github.event.inputs.services_url }}
          fi
          if [ -n "${{ github.event.inputs.miui_services_url }}" ]; then
            wget -O miui-services.jar ${{ github.event.inputs.miui_services_url }}
          fi

      - name: Install 7-Zip
        run: sudo apt-get update && sudo apt-get install -y p7zip-full

      - name: Extract JARs
        run: |
          if [ -f "framework.jar" ]; then
            7z x -y framework.jar -oframework
          fi
          
          if [ -f "services.jar" ]; then
            7z x -y services.jar -oservices
          fi
          
          if [ -f "miui-services.jar" ]; then
            7z x -y miui-services.jar -omiui_services
          fi

      - name: Decompile JARs using script
        run: |
          if [ -f "framework.jar" ]; then
            python3 decompile.py --jar framework.jar --api_level ${{ github.event.inputs.api_level }}
          fi
          if [ -f "services.jar" ]; then
            python3 decompile.py --jar services.jar --api_level ${{ github.event.inputs.api_level }}
          fi
          if [ -f "miui-services.jar" ]; then
            python3 decompile.py --jar miui-services.jar --api_level ${{ github.event.inputs.api_level }}
          fi

      - name: Patch JARs
        run: |
          python3 patch.py --api_level ${{ github.event.inputs.api_level }} \
            ${{ github.event.inputs.framework_url && '--framework' }} \
            ${{ github.event.inputs.services_url && '--services' }} \
            ${{ github.event.inputs.miui_services_url && '--miui-services' }}

      - name: Prepare Magisk Module
        run: |
          cp -r magisk_module/. build_module/
          
          mkdir -p build_module/system/framework
          [ -f "framework_patched.jar" ] && mv framework_patched.jar build_module/system/framework/framework.jar
          [ -f "services_patched.jar" ] && mv services_patched.jar build_module/system/framework/services.jar
          [ -f "miui-services_patched.jar" ] && mv miui-services_patched.jar build_module/system/framework/miui-services.jar
          
          CURRENT_DATE=$(date +%Y%m%d)
          sed -i "s/version=.*/version=$CURRENT_DATE/" build_module/module.prop
          sed -i "s/versionCode=.*/versionCode=$CURRENT_DATE/" build_module/module.prop
          
          cd build_module
          zip -r9 ../patched_module.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: patched_module.zip
          tag_name: ${{ format('v{0}-{1}', github.run_number, github.sha) }}
          name: "Framework Patch ${{ github.run_number }}"
          body: |
            Framework Patcher build from:
            - Framework: ${{ github.event.inputs.framework_url }}
            - Services: ${{ github.event.inputs.services_url }}
            - MIUI Services: ${{ github.event.inputs.miui_services_url }}
            - API Level: ${{ github.event.inputs.api_level }}
            
            SHA: ${{ github.sha }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
